{"id": 33, "timestamp": "2026-01-06T15:16:07.101584", "source": "agent", "message": "I read the file /workspace/django__django__4.1/tests/migrations/test_base.py.", "cause": 32, "observation": "read", "tool_call_metadata": {"function_name": "str_replace_editor", "tool_call_id": "toolu_14", "model_response": {"id": "chatcmpl-ec13669292e9463689f04d56f52b1723", "created": 1767712565, "model": "/mnt/shared/models/GLM-4.6-FP8", "object": "chat.completion", "system_fingerprint": null, "choices": [{"finish_reason": "stop", "index": 0, "message": {"content": "<think></think>", "role": "assistant", "tool_calls": [{"index": 1, "function": {"arguments": "{\"command\": \"view\", \"path\": \"/workspace/django__django__4.1/tests/migrations/test_base.py\", \"security_risk\": \"LOW\"}", "name": "str_replace_editor"}, "id": "toolu_14", "type": "function"}], "function_call": null, "provider_specific_fields": null}}], "usage": {"completion_tokens": 54, "prompt_tokens": 0, "total_tokens": 54, "completion_tokens_details": {"accepted_prediction_tokens": null, "audio_tokens": null, "reasoning_tokens": 0, "rejected_prediction_tokens": null, "text_tokens": null, "image_tokens": null}, "prompt_tokens_details": null}}, "total_calls_in_response": 1}, "content": "Here's the result of running `cat -n` on /workspace/django__django__4.1/tests/migrations/test_base.py:\n     1\timport os\n     2\timport shutil\n     3\timport tempfile\n     4\tfrom contextlib import contextmanager\n     5\tfrom importlib import import_module\n     6\t\n     7\tfrom django.apps import apps\n     8\tfrom django.db import connection, connections, migrations, models\n     9\tfrom django.db.migrations.migration import Migration\n    10\tfrom django.db.migrations.recorder import MigrationRecorder\n    11\tfrom django.db.migrations.state import ProjectState\n    12\tfrom django.test import TransactionTestCase\n    13\tfrom django.test.utils import extend_sys_path\n    14\tfrom django.utils.module_loading import module_dir\n    15\t\n    16\t\n    17\tclass MigrationTestBase(TransactionTestCase):\n    18\t    \"\"\"\n    19\t    Contains an extended set of asserts for testing migrations and schema operations.\n    20\t    \"\"\"\n    21\t\n    22\t    available_apps = [\"migrations\"]\n    23\t    databases = {'default', 'other'}\n    24\t\n    25\t    def tearDown(self):\n    26\t        # Reset applied-migrations state.\n    27\t        for db in self.databases:\n    28\t            recorder = MigrationRecorder(connections[db])\n    29\t            recorder.migration_qs.filter(app='migrations').delete()\n    30\t\n    31\t    def get_table_description(self, table, using='default'):\n    32\t        with connections[using].cursor() as cursor:\n    33\t            return connections[using].introspection.get_table_description(cursor, table)\n    34\t\n    35\t    def assertTableExists(self, table, using='default'):\n    36\t        with connections[using].cursor() as cursor:\n    37\t            self.assertIn(table, connections[using].introspection.table_names(cursor))\n    38\t\n    39\t    def assertTableNotExists(self, table, using='default'):\n    40\t        with connections[using].cursor() as cursor:\n    41\t            self.assertNotIn(table, connections[using].introspection.table_names(cursor))\n    42\t\n    43\t    def assertColumnExists(self, table, column, using='default'):\n    44\t        self.assertIn(column, [c.name for c in self.get_table_description(table, using=using)])\n    45\t\n    46\t    def assertColumnNotExists(self, table, column, using='default'):\n    47\t        self.assertNotIn(column, [c.name for c in self.get_table_description(table, using=using)])\n    48\t\n    49\t    def _get_column_allows_null(self, table, column, using):\n    50\t        return [c.null_ok for c in self.get_table_description(table, using=using) if c.name == column][0]\n    51\t\n    52\t    def assertColumnNull(self, table, column, using='default'):\n    53\t        self.assertTrue(self._get_column_allows_null(table, column, using))\n    54\t\n    55\t    def assertColumnNotNull(self, table, column, using='default'):\n    56\t        self.assertFalse(self._get_column_allows_null(table, column, using))\n    57\t\n    58\t    def assertIndexExists(self, table, columns, value=True, using='default', index_type=None):\n    59\t        with connections[using].cursor() as cursor:\n    60\t            self.assertEqual(\n    61\t                value,\n    62\t                any(\n    63\t                    c[\"index\"]\n    64\t                    for c in connections[using].introspection.get_constraints(cursor, table).values()\n    65\t                    if (\n    66\t                        c['columns'] == list(columns) and\n    67\t                        (index_type is None or c['type'] == index_type) and\n    68\t                        not c['unique']\n    69\t                    )\n    70\t                ),\n    71\t            )\n    72\t\n    73\t    def assertIndexNotExists(self, table, columns):\n    74\t        return self.assertIndexExists(table, columns, False)\n    75\t\n    76\t    def assertIndexNameExists(self, table, index, using='default'):\n    77\t        with connections[using].cursor() as cursor:\n    78\t            self.assertIn(\n    79\t                index,\n    80\t                connection.introspection.get_constraints(cursor, table),\n    81\t            )\n    82\t\n    83\t    def assertIndexNameNotExists(self, table, index, using='default'):\n    84\t        with connections[using].cursor() as cursor:\n    85\t            self.assertNotIn(\n    86\t                index,\n    87\t                connection.introspection.get_constraints(cursor, table),\n    88\t            )\n    89\t\n    90\t    def assertConstraintExists(self, table, name, value=True, using='default'):\n    91\t        with connections[using].cursor() as cursor:\n    92\t            constraints = connections[using].introspection.get_constraints(cursor, table).items()\n    93\t            self.assertEqual(\n    94\t                value,\n    95\t                any(c['check'] for n, c in constraints if n == name),\n    96\t            )\n    97\t\n    98\t    def assertConstraintNotExists(self, table, name):\n    99\t        return self.assertConstraintExists(table, name, False)\n   100\t\n   101\t    def assertUniqueConstraintExists(self, table, columns, value=True, using='default'):\n   102\t        with connections[using].cursor() as cursor:\n   103\t            constraints = connections[using].introspection.get_constraints(cursor, table).values()\n   104\t            self.assertEqual(\n   105\t                value,\n   106\t                any(c['unique'] for c in constraints if c['columns'] == list(columns)),\n   107\t            )\n   108\t\n   109\t    def assertFKExists(self, table, columns, to, value=True, using='default'):\n   110\t        with connections[using].cursor() as cursor:\n   111\t            self.assertEqual(\n   112\t                value,\n   113\t                any(\n   114\t                    c[\"foreign_key\"] == to\n   115\t                    for c in connections[using].introspection.get_constraints(cursor, table).values()\n   116\t                    if c['columns'] == list(columns)\n   117\t                ),\n   118\t            )\n   119\t\n   120\t    def assertFKNotExists(self, table, columns, to):\n   121\t        return self.assertFKExists(table, columns, to, False)\n   122\t\n   123\t    @contextmanager\n   124\t    def temporary_migration_module(self, app_label='migrations', module=None):\n   125\t        \"\"\"\n   126\t        Allows testing management commands in a temporary migrations module.\n   127\t\n   128\t        Wrap all invocations to makemigrations and squashmigrations with this\n   129\t        context manager in order to avoid creating migration files in your\n   130\t        source tree inadvertently.\n   131\t\n   132\t        Takes the application label that will be passed to makemigrations or\n   133\t        squashmigrations and the Python path to a migrations module.\n   134\t\n   135\t        The migrations module is used as a template for creating the temporary\n   136\t        migrations module. If it isn't provided, the application's migrations\n   137\t        module is used, if it exists.\n   138\t\n   139\t        Returns the filesystem path to the temporary migrations module.\n   140\t        \"\"\"\n   141\t        with tempfile.TemporaryDirectory() as temp_dir:\n   142\t            target_dir = tempfile.mkdtemp(dir=temp_dir)\n   143\t            with open(os.path.join(target_dir, '__init__.py'), 'w'):\n   144\t                pass\n   145\t            target_migrations_dir = os.path.join(target_dir, 'migrations')\n   146\t\n   147\t            if module is None:\n   148\t                module = apps.get_app_config(app_label).name + '.migrations'\n   149\t\n   150\t            try:\n   151\t                source_migrations_dir = module_dir(import_module(module))\n   152\t            except (ImportError, ValueError):\n   153\t                pass\n   154\t            else:\n   155\t                shutil.copytree(source_migrations_dir, target_migrations_dir)\n   156\t\n   157\t            with extend_sys_path(temp_dir):\n   158\t                new_module = os.path.basename(target_dir) + '.migrations'\n   159\t                with self.settings(MIGRATION_MODULES={app_label: new_module}):\n   160\t                    yield target_migrations_dir\n   161\t\n   162\t\n   163\tclass OperationTestBase(MigrationTestBase):\n   164\t    \"\"\"Common functions to help test operations.\"\"\"\n   165\t\n   166\t    @classmethod\n   167\t    def setUpClass(cls):\n   168\t        super().setUpClass()\n   169\t        cls._initial_table_names = frozenset(connection.introspection.table_names())\n   170\t\n   171\t    def tearDown(self):\n   172\t        self.cleanup_test_tables()\n   173\t        super().tearDown()\n   174\t\n   175\t    def cleanup_test_tables(self):\n   176\t        table_names = frozenset(connection.introspection.table_names()) - self._initial_table_names\n   177\t        with connection.schema_editor() as editor:\n   178\t            with connection.constraint_checks_disabled():\n   179\t                for table_name in table_names:\n   180\t                    editor.execute(editor.sql_delete_table % {\n   181\t                        'table': editor.quote_name(table_name),\n   182\t                    })\n   183\t\n   184\t    def apply_operations(self, app_label, project_state, operations, atomic=True):\n   185\t        migration = Migration('name', app_label)\n   186\t        migration.operations = operations\n   187\t        with connection.schema_editor(atomic=atomic) as editor:\n   188\t            return migration.apply(project_state, editor)\n   189\t\n   190\t    def unapply_operations(self, app_label, project_state, operations, atomic=True):\n   191\t        migration = Migration('name', app_label)\n   192\t        migration.operations = operations\n   193\t        with connection.schema_editor(atomic=atomic) as editor:\n   194\t            return migration.unapply(project_state, editor)\n   195\t\n   196\t    def make_test_state(self, app_label, operation, **kwargs):\n   197\t        \"\"\"\n   198\t        Makes a test state using set_up_test_model and returns the\n   199\t        original state and the state after the migration is applied.\n   200\t        \"\"\"\n   201\t        project_state = self.set_up_test_model(app_label, **kwargs)\n   202\t        new_state = project_state.clone()\n   203\t        operation.state_forwards(app_label, new_state)\n   204\t        return project_state, new_state\n   205\t\n   206\t    def set_up_test_model(\n   207\t        self, app_label, second_model=False, third_model=False, index=False,\n   208\t        multicol_index=False, related_model=False, mti_model=False,\n   209\t        proxy_model=False, manager_model=False, unique_together=False,\n   210\t        options=False, db_table=None, index_together=False, constraints=None,\n   211\t        indexes=None,\n   212\t    ):\n   213\t        \"\"\"Creates a test model state and database table.\"\"\"\n   214\t        # Make the \"current\" state.\n   215\t        model_options = {\n   216\t            'swappable': 'TEST_SWAP_MODEL',\n   217\t            'index_together': [['weight', 'pink']] if index_together else [],\n   218\t            'unique_together': [['pink', 'weight']] if unique_together else [],\n   219\t        }\n   220\t        if options:\n   221\t            model_options['permissions'] = [('can_groom', 'Can groom')]\n   222\t        if db_table:\n   223\t            model_options['db_table'] = db_table\n   224\t        operations = [migrations.CreateModel(\n   225\t            'Pony',\n   226\t            [\n   227\t                ('id', models.AutoField(primary_key=True)),\n   228\t                ('pink', models.IntegerField(default=3)),\n   229\t                ('weight', models.FloatField()),\n   230\t            ],\n   231\t            options=model_options,\n   232\t        )]\n   233\t        if index:\n   234\t            operations.append(migrations.AddIndex(\n   235\t                'Pony',\n   236\t                models.Index(fields=['pink'], name='pony_pink_idx'),\n   237\t            ))\n   238\t        if multicol_index:\n   239\t            operations.append(migrations.AddIndex(\n   240\t                'Pony',\n   241\t                models.Index(fields=['pink', 'weight'], name='pony_test_idx'),\n   242\t            ))\n   243\t        if indexes:\n   244\t            for index in indexes:\n   245\t                operations.append(migrations.AddIndex('Pony', index))\n   246\t        if constraints:\n   247\t            for constraint in constraints:\n   248\t                operations.append(migrations.AddConstraint('Pony', constraint))\n   249\t        if second_model:\n   250\t            operations.append(migrations.CreateModel(\n   251\t                'Stable',\n   252\t                [\n   253\t                    ('id', models.AutoField(primary_key=True)),\n   254\t                ]\n   255\t            ))\n   256\t        if third_model:\n   257\t            operations.append(migrations.CreateModel(\n   258\t                'Van',\n   259\t                [\n   260\t                    ('id', models.AutoField(primary_key=True)),\n   261\t                ]\n   262\t            ))\n   263\t        if related_model:\n   264\t            operations.append(migrations.CreateModel(\n   265\t                'Rider',\n   266\t                [\n   267\t                    ('id', models.AutoField(primary_key=True)),\n   268\t                    ('pony', models.ForeignKey('Pony', models.CASCADE)),\n   269\t                    ('friend', models.ForeignKey('self', models.CASCADE, null=True))\n   270\t                ],\n   271\t            ))\n   272\t        if mti_model:\n   273\t            operations.append(migrations.CreateModel(\n   274\t                'ShetlandPony',\n   275\t                fields=[\n   276\t                    ('pony_ptr', models.OneToOneField(\n   277\t                        'Pony',\n   278\t                        models.CASCADE,\n   279\t                        auto_created=True,\n   280\t                        parent_link=True,\n   281\t                        primary_key=True,\n   282\t                        to_field='id',\n   283\t                        serialize=False,\n   284\t                    )),\n   285\t                    ('cuteness', models.IntegerField(default=1)),\n   286\t                ],\n   287\t                bases=['%s.Pony' % app_label],\n   288\t            ))\n   289\t        if proxy_model:\n   290\t            operations.append(migrations.CreateModel(\n   291\t                'ProxyPony',\n   292\t                fields=[],\n   293\t                options={'proxy': True},\n   294\t                bases=['%s.Pony' % app_label],\n   295\t            ))\n   296\t        if manager_model:\n   297\t            from .models import FoodManager, FoodQuerySet\n   298\t            operations.append(migrations.CreateModel(\n   299\t                'Food',\n   300\t                fields=[\n   301\t                    ('id', models.AutoField(primary_key=True)),\n   302\t                ],\n   303\t                managers=[\n   304\t                    ('food_qs', FoodQuerySet.as_manager()),\n   305\t                    ('food_mgr', FoodManager('a', 'b')),\n   306\t                    ('food_mgr_kwargs', FoodManager('x', 'y', 3, 4)),\n   307\t                ]\n   308\t            ))\n   309\t        return self.apply_operations(app_label, ProjectState(), operations)\n   310\t\n", "extras": {"path": "/workspace/django__django__4.1/tests/migrations/test_base.py", "impl_source": "oh_aci"}}