2026-01-06 15:22:06,289 - INFO - [LLM registry e19f14eb-ee61-48b5-ac57-7d408ea4e556]: Registering service for agent
2026-01-06 15:22:06,335 - INFO - Building image: ghcr.io/openhands/runtime:oh_v1.0.0_8idafuueo9wvx0jg_v008aov5t6vw3gr5
2026-01-06 15:26:48,300 - INFO - Image [ghcr.io/openhands/runtime:oh_v1.0.0_8idafuueo9wvx0jg_v008aov5t6vw3gr5] build finished.
2026-01-06 15:26:48,311 - INFO - Re-tagged image [ghcr.io/openhands/runtime:oh_v1.0.0_8idafuueo9wvx0jg_v008aov5t6vw3gr5] with more generic tag [oh_v1.0.0_8idafuueo9wvx0jg]
2026-01-06 15:26:48,314 - INFO - Image ghcr.io/openhands/runtime with tags [oh_v1.0.0_8idafuueo9wvx0jg_v008aov5t6vw3gr5, oh_v1.0.0_8idafuueo9wvx0jg] built successfully
2026-01-06 15:26:48,362 - INFO - [runtime a5c91cf5-f5a2-47-bc3575c9efbea9e] Starting runtime with image: ghcr.io/openhands/runtime:oh_v1.0.0_8idafuueo9wvx0jg_v008aov5t6vw3gr5
2026-01-06 15:26:48,508 - INFO - [runtime a5c91cf5-f5a2-47-bc3575c9efbea9e] Starting server with command: ['/openhands/micromamba/bin/micromamba', 'run', '-n', 'openhands', 'poetry', 'run', 'python', '-u', '-m', 'openhands.runtime.action_execution_server', '30282', '--working-dir', '/workspace', '--plugins', 'agent_skills', 'jupyter', '--username', 'root', '--user-id', '0', '--no-enable-browser']
2026-01-06 15:26:50,492 - INFO - [runtime a5c91cf5-f5a2-47-bc3575c9efbea9e] Container started: openhands-runtime-a5c91cf5-f5a2-47-bc3575c9efbea9e. VSCode URL: None
2026-01-06 15:26:50,492 - INFO - [runtime a5c91cf5-f5a2-47-bc3575c9efbea9e] Waiting for client to become ready at http://localhost:30282...
2026-01-06 15:27:18,566 - INFO - [runtime a5c91cf5-f5a2-47-bc3575c9efbea9e] Runtime is ready.
2026-01-06 15:27:21,680 - INFO - Successfully configured git: name=openhands, email=openhands@all-hands.dev
2026-01-06 15:27:21,682 - INFO - ------------------------------
2026-01-06 15:27:21,682 - INFO - BEGIN Runtime Initialization Fn
2026-01-06 15:27:21,682 - INFO - ------------------------------
2026-01-06 15:27:21,683 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
echo 'export SWE_INSTANCE_ID=django__django-16400' >> ~/.bashrc && echo 'export PIP_CACHE_DIR=~/.cache/pip' >> ~/.bashrc && echo "alias git='git --no-pager'" >> ~/.bashrc && git config --global core.pager "" && git config --global diff.binary false
2026-01-06 15:27:22,308 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:22,309 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
export USER=$(whoami); echo USER=${USER} 
2026-01-06 15:27:22,929 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
USER=root
[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:22,929 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
mkdir -p /swe_util/eval_data/instances
2026-01-06 15:27:23,546 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:23,553 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
cat ~/.bashrc
2026-01-06 15:27:24,170 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
source /opt/miniconda3/etc/profile.d/conda.sh && conda activate testbed

. "/openhands/bin/env"
export PATH="/usr/bin:/bin:/usr/sbin:/sbin:/openhands/micromamba/bin:$PATH"
export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
eval "$(/openhands/micromamba/bin/micromamba shell hook --shell bash)"
micromamba activate openhands 2>/dev/null || true
export ENABLE_AUTO_LINT=true
export NO_CHANGE_TIMEOUT_SECONDS=30
export OPENHANDS_EVAL_INSTANCE_ID=django__django-16400
export OPENHANDS_EVAL_JOB_ID=1931734182
export OPENHANDS_TIMING_DIR=./continuum32/princeton-nlp__SWE-bench_Lite-test/CodeActAgent/GLM-4.6-FP8_maxiter_135/timing
export SWE_INSTANCE_ID=django__django-16400
export PIP_CACHE_DIR=~/.cache/pip
alias git='git --no-pager'
[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:24,171 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
source ~/.bashrc
2026-01-06 15:27:24,788 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:24,788 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
source /swe_util/instance_swe_entry.sh
2026-01-06 15:27:26,421 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
WORKSPACE_NAME: django__django__4.2
[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:26,421 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
cd /workspace/django__django__4.2
2026-01-06 15:27:27,039 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:27,040 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git reset --hard
2026-01-06 15:27:29,169 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
Updating files: 100% (6661/6661), done.
HEAD is now at 0bd2c0c901 Fixed #33735 -- Added async support to StreamingHttpResponse.
[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:29,169 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
for remote_name in $(git remote); do git remote remove "${remote_name}"; done
2026-01-06 15:27:29,798 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:29,799 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
which python
2026-01-06 15:27:30,429 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
/opt/miniconda3/envs/testbed/bin/python
[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:27:30,430 - INFO - ------------------------------
2026-01-06 15:27:30,430 - INFO - END Runtime Initialization Fn
2026-01-06 15:27:30,430 - INFO - ------------------------------
2026-01-06 15:27:30,433 - INFO - [LLM registry 51a249e3-8db8-4d07-b26c-7745f1687a19]: Registering service for agent
2026-01-06 15:27:30,443 - INFO - [runtime a5c91cf5-f5a2-47-bc3575c9efbea9e] Selected repo: None, loading microagents from /workspace/.openhands/microagents (inside runtime)
2026-01-06 15:27:30,447 - INFO - [runtime a5c91cf5-f5a2-47-bc3575c9efbea9e] Attempting to list files in repository microagents directory: /workspace/.openhands/microagents
2026-01-06 15:27:30,449 - INFO - Loading user workspace microagents: []
2026-01-06 15:27:30,449 - INFO - AgentController a5c91cf5-f5a2-47-bc3575c9efbea9e - created new state. start_id: 0
2026-01-06 15:27:30,455 - INFO - [Agent Controller a5c91cf5-f5a2-47-bc3575c9efbea9e] Setting agent(CodeActAgent) state from AgentState.LOADING to AgentState.RUNNING
2026-01-06 15:27:30,456 - INFO - Microagent 'security' triggered by keyword 'security'
2026-01-06 15:27:30,457 - INFO - Saved conversation stats
2026-01-06 15:34:37,403 - INFO - [Agent Controller a5c91cf5-f5a2-47-bc3575c9efbea9e] Setting agent(CodeActAgent) state from AgentState.RUNNING to AgentState.FINISHED
2026-01-06 15:34:37,404 - INFO - Saved conversation stats
2026-01-06 15:34:37,876 - INFO - ------------------------------
2026-01-06 15:34:37,876 - INFO - BEGIN Runtime Completion Fn
2026-01-06 15:34:37,876 - INFO - ------------------------------
2026-01-06 15:34:37,876 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
cd /workspace/django__django__4.2
2026-01-06 15:34:38,495 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:34:38,495 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git config --global core.pager ""
2026-01-06 15:34:39,114 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:34:39,115 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
find . -type d -name .git -not -path "./.git"
2026-01-06 15:34:39,734 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:34:39,734 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git add -A
2026-01-06 15:34:40,355 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:34:40,356 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
for file in $(git status --porcelain | grep -E "^(M| M|\?\?|A| A)" | cut -c4-); do
        if [ -f "$file" ] && (file "$file" | grep -q "executable" || git check-attr binary "$file" | grep -q "binary: set"); then
            git rm -f "$file" 2>/dev/null || rm -f "$file"
            echo "Removed: $file"
        fi
    done
2026-01-06 15:34:40,982 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
bash: file: command not found
bash: file: command not found
bash: file: command not found
bash: file: command not found
bash: file: command not found
[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:34:40,982 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git diff --no-color --cached 0bd2c0c9015b53c41394a1c0989afbfd94dc2830 > patch.diff
2026-01-06 15:34:41,603 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "ac90b66856eb",
  "working_dir": "/workspace/django__django__4.2",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.2]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:34:41,604 - INFO - FileReadAction(path='patch.diff', start=0, end=-1, thought='', action=<ActionType.READ: 'read'>, security_risk=<ActionSecurityRisk.UNKNOWN: -1>, impl_source=<FileReadSource.DEFAULT: 'default'>, view_range=None)
2026-01-06 15:34:41,607 - INFO - [Read from /workspace/django__django__4.2/patch.diff is successful.]
diff --git a/django/contrib/auth/management/__init__.py b/django/contrib/auth/management/__init__.py
index 0b5a982617..d36f6a99df 100644
--- a/django/contrib/auth/management/__init__.py
+++ b/django/contrib/auth/management/__init__.py
@@ -79,7 +79,8 @@ def create_permissions(
         ctype = ContentType.objects.db_manager(using).get_for_model(
             klass, for_concrete_model=False
         )
-
+        # Ensure the ContentType has the correct database state
+        ctype._state.db = using
         ctypes.add(ctype)
         for perm in _get_all_permissions(klass._meta):
             searched_perms.append((ctype, perm))
@@ -100,6 +101,8 @@ def create_permissions(
         for ct, (codename, name) in searched_perms
         if (ct.pk, codename) not in all_perms
     ]
+    # Create permissions using the specified database to ensure
+    # foreign key assignments respect the database parameter
     Permission.objects.using(using).bulk_create(perms)
     if verbosity >= 2:
         for perm in perms:
diff --git a/django/db/models/fields/related_descriptors.py b/django/db/models/fields/related_descriptors.py
index 422b08e6ca..c914a36805 100644
--- a/django/db/models/fields/related_descriptors.py
+++ b/django/db/models/fields/related_descriptors.py
@@ -274,13 +274,21 @@ class ForwardManyToOneDescriptor:
             )
         elif value is not None:
             if instance._state.db is None:
-                instance._state.db = router.db_for_write(
-                    instance.__class__, instance=value
-                )
+                # If the related value has a database set, use that for routing
+                if value._state.db is not None:
+                    instance._state.db = value._state.db
+                else:
+                    instance._state.db = router.db_for_write(
+                        instance.__class__, instance=value
+                    )
             if value._state.db is None:
-                value._state.db = router.db_for_write(
-                    value.__class__, instance=instance
-                )
+                # If the instance has a database set, use that for routing
+                if instance._state.db is not None:
+                    value._state.db = instance._state.db
+                else:
+                    value._state.db = router.db_for_write(
+                        value.__class__, instance=instance
+                    )
             if not router.allow_relation(value, instance):
                 raise ValueError(
                     'Cannot assign "%r": the current database router prevents this '
diff --git a/test_comprehensive_migrate.py b/test_comprehensive_migrate.py
new file mode 100644
index 0000000000..28219ca70d
--- /dev/null
+++ b/test_comprehensive_migrate.py
@@ -0,0 +1,161 @@
+#!/usr/bin/env python
+"""
+Comprehensive test for the migrate command database parameter fix.
+"""
+import os
+import sys
+import tempfile
+import shutil
+from threading import local
+
+# Add Django to path
+sys.path.insert(0, '/workspace/django__django__4.2')
+
+# Set up Django settings
+os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'test_settings')
+
+# Create test settings
+import django
+from django.conf import settings
+from django.core.management import execute_from_command_line
+from django.apps import apps
+
+# Global state to track router calls
+router_calls = []
+
+class InvalidTenantException(Exception):
+    pass
+
+local_state = local()
+
+class TenantDatabaseRouter:
+    """Custom DB router that tracks calls and requires tenant context"""
+    
+    def _default_db(self):
+        subdomain = getattr(local_state, "subdomain", None)
+        if subdomain is not None and subdomain in {"localhost", "tenant_1"}:
+            return "default"
+        else:
+            raise InvalidTenantException(f"No tenant context: subdomain={subdomain}")
+    
+    def db_for_read(self, model, **hints):
+        router_calls.append(('read', model.__name__, hints))
+        return self._default_db()
+    
+    def db_for_write(self, model, **hints):
+        router_calls.append(('write', model.__name__, hints))
+        return self._default_db()
+    
+    def allow_relation(self, obj1, obj2, **hints):
+        return None
+    
+    def allow_migrate(self, db, app_label, model_name=None, **hints):
+        return None
+
+def configure_test_settings():
+    """Configure Django settings for testing"""
+    if not settings.configured:
+        settings.configure(
+            DEBUG=True,
+            DATABASES={
+                'default': {
+                    'ENGINE': 'django.db.backends.sqlite3',
+                    'NAME': ':memory:',
+                }
+            },
+            INSTALLED_APPS=[
+                'django.contrib.contenttypes',
+                'django.contrib.auth',
+                'django.contrib.sessions',
+                'django.contrib.messages',
+            ],
+            DATABASE_ROUTERS=['test_comprehensive_migrate.TenantDatabaseRouter'],
+            SECRET_KEY='test-secret-key',
+            USE_TZ=True,
+        )
+        django.setup()
+
+def test_migrate_scenarios():
+    """Test various migrate scenarios"""
+    print("Testing comprehensive migrate scenarios...")
+    
+    test_results = []
+    
+    # Test 1: Migrate with database parameter and tenant context
+    print("\n1. Testing migrate with --database parameter and tenant context...")
+    router_calls.clear()
+    local_state.subdomain = "localhost"
+    
+    try:
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        print("‚úÖ SUCCESS: Migrate completed without router errors")
+        test_results.append(("migrate_with_db_param", True, len(router_calls)))
+    except Exception as e:
+        print(f"‚ùå FAILED: {e}")
+        test_results.append(("migrate_with_db_param", False, len(router_calls)))
+    finally:
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+    
+    # Test 2: Migrate without tenant context (should fail)
+    print("\n2. Testing migrate without tenant context (should fail)...")
+    router_calls.clear()
+    
+    try:
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        print("‚ùå UNEXPECTED: Migrate should have failed without tenant context")
+        test_results.append(("migrate_without_context", False, len(router_calls)))
+    except InvalidTenantException as e:
+        print(f"‚úÖ EXPECTED: Migrate failed as expected: {e}")
+        test_results.append(("migrate_without_context", True, len(router_calls)))
+    except Exception as e:
+        print(f"‚ùå UNEXPECTED ERROR: {e}")
+        test_results.append(("migrate_without_context", False, len(router_calls)))
+    
+    # Test 3: Test that permissions are actually created
+    print("\n3. Testing that permissions are created correctly...")
+    try:
+        from django.contrib.auth.models import Permission
+        from django.contrib.contenttypes.models import ContentType
+        
+        # Set tenant context
+        local_state.subdomain = "localhost"
+        
+        # Count permissions
+        permission_count = Permission.objects.using('default').count()
+        contenttype_count = ContentType.objects.using('default').count()
+        
+        print(f"‚úÖ SUCCESS: Found {permission_count} permissions and {contenttype_count} content types")
+        test_results.append(("permissions_created", True, permission_count))
+        
+    except Exception as e:
+        print(f"‚ùå FAILED: {e}")
+        test_results.append(("permissions_created", False, 0))
+    finally:
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+    
+    return test_results
+
+if __name__ == '__main__':
+    configure_test_settings()
+    results = test_migrate_scenarios()
+    
+    print("\n" + "="*60)
+    print("SUMMARY:")
+    print("="*60)
+    
+    all_passed = True
+    for test_name, passed, details in results:
+        status = "‚úÖ PASS" if passed else "‚ùå FAIL"
+        print(f"{status}: {test_name} (details: {details})")
+        if not passed:
+            all_passed = False
+    
+    print("="*60)
+    if all_passed:
+        print("üéâ ALL TESTS PASSED!")
+        sys.exit(0)
+    else:
+        print("üí• SOME TESTS FAILED!")
+        sys.exit(1)
diff --git a/test_issue_reproduction.py b/test_issue_reproduction.py
new file mode 100644
index 0000000000..4703cafee1
--- /dev/null
+++ b/test_issue_reproduction.py
@@ -0,0 +1,141 @@
+#!/usr/bin/env python
+"""
+Test script that exactly reproduces the issue described in the GitHub issue.
+
+This reproduces the minimal example from the issue description.
+"""
+import os
+import sys
+from threading import local
+
+# Add Django to path
+sys.path.insert(0, '/workspace/django__django__4.2')
+
+# Set up Django settings
+os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'test_settings')
+
+# Create test settings
+import django
+from django.conf import settings
+from django.core.management import execute_from_command_line
+
+# Reproduce the exact code from the issue
+local_state = local()
+
+class InvalidTenantException(Exception):
+    pass
+
+class TenantSubdomainMiddleware:
+    def __init__(self, get_response):
+        self.get_response = get_response
+    def __call__(self, request):
+        ## Get Subdomain
+        host = request.get_host().split(":")[0]
+        local_state.subdomain = (
+            # We assume single level of subdomain : app.service.com 
+            # HOST_IP : used to for local dev. 
+            host if host in ["127.0.0.1", "localhost"] else host.split(".")[0]
+        )
+        response = self.get_response(request)
+        return response
+
+class TenantDatabaseRouter:
+    def _default_db(self):
+        subdomain = getattr(local_state, "subdomain", None)
+        if subdomain is not None and subdomain in {"localhost", "tenant_1"}:
+            return "default"
+        else:
+            raise InvalidTenantException()
+    
+    def db_for_read(self, model, **hints):
+        print("read", hints)
+        return self._default_db()
+    
+    def db_for_write(self, model, **hints):
+        print("write", hints)
+        return self._default_db()
+    
+    def allow_relation(self, obj1, obj2, **hints):
+        return None
+    
+    def allow_migrate(self, db, app_label, model_name=None, **hints):
+        return None
+
+def configure_test_settings():
+    """Configure Django settings exactly as in the issue"""
+    if not settings.configured:
+        settings.configure(
+            DEBUG=True,
+            DATABASES={
+                'default': {
+                    'ENGINE': 'django.db.backends.sqlite3',
+                    'NAME': ':memory:',
+                }
+            },
+            INSTALLED_APPS=[
+                'django.contrib.contenttypes',
+                'django.contrib.auth',
+                'django.contrib.sessions',
+                'django.contrib.messages',
+            ],
+            MIDDLEWARE=[
+                "test_issue_reproduction.TenantSubdomainMiddleware",
+                "django.middleware.security.SecurityMiddleware",
+            ],
+            TENANT_MAP = {"localhost":"default", "tenant_1":"default"},
+            DATABASE_ROUTERS = ["test_issue_reproduction.TenantDatabaseRouter"],
+            SECRET_KEY='test-secret-key',
+            USE_TZ=True,
+        )
+        django.setup()
+
+def test_issue_reproduction():
+    """Test the exact scenario from the issue"""
+    print("Reproducing the exact issue scenario...")
+    print("="*60)
+    
+    # Set tenant context as would be done by middleware
+    local_state.subdomain = "localhost"
+    
+    try:
+        print("Running: python manage.py migrate --database=default")
+        print("Expected: Should complete without 'read {}' being printed before exception")
+        print("-" * 60)
+        
+        # Run migrate with database parameter
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        
+        print("-" * 60)
+        print("‚úÖ SUCCESS: Migration completed without the problematic 'read {}' output!")
+        print("‚úÖ The database parameter is now properly respected!")
+        return True
+        
+    except InvalidTenantException:
+        print("-" * 60)
+        print("‚ùå FAILED: InvalidTenantException was raised")
+        print("‚ùå This means the database router was called without proper context")
+        return False
+        
+    except Exception as e:
+        print("-" * 60)
+        print(f"‚ùå FAILED: Unexpected error: {e}")
+        return False
+        
+    finally:
+        # Clean up tenant context
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+
+if __name__ == '__main__':
+    configure_test_settings()
+    success = test_issue_reproduction()
+    
+    print("\n" + "="*60)
+    if success:
+        print("üéâ ISSUE FIXED: The migrate command now respects the database parameter!")
+        print("üéâ No more problematic 'read {}' calls without proper database context!")
+    else:
+        print("üí• ISSUE NOT FIXED: The problem still exists")
+    print("="*60)
+    
+    sys.exit(0 if success else 1)
diff --git a/test_migrate_db_issue.py b/test_migrate_db_issue.py
new file mode 100644
index 0000000000..1dfb7aa1bd
--- /dev/null
+++ b/test_migrate_db_issue.py
@@ -0,0 +1,139 @@
+#!/usr/bin/env python
+"""
+Test script to reproduce the migrate command database parameter issue.
+
+The issue: When running migrate with a database parameter, there's a DB read 
+request that runs after the migration which doesn't respect the db param and 
+invokes the db router.
+"""
+import os
+import sys
+import tempfile
+import shutil
+from threading import local
+
+# Add Django to path
+sys.path.insert(0, '/workspace/django__django__4.2')
+
+# Set up Django settings
+os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'test_settings')
+
+# Create test settings
+import django
+from django.conf import settings
+from django.core.management import execute_from_command_line
+
+# Global state to track router calls
+router_calls = []
+
+class InvalidTenantException(Exception):
+    pass
+
+local_state = local()
+
+class TenantDatabaseRouter:
+    """Custom DB router that tracks calls and requires tenant context"""
+    
+    def _default_db(self):
+        subdomain = getattr(local_state, "subdomain", None)
+        if subdomain is not None and subdomain in {"localhost", "tenant_1"}:
+            return "default"
+        else:
+            raise InvalidTenantException(f"No tenant context: subdomain={subdomain}")
+    
+    def db_for_read(self, model, **hints):
+        import traceback
+        print(f"\nüîç db_for_read called for model: {model.__name__}")
+        print(f"   Hints: {hints}")
+        print(f"   Current subdomain: {getattr(local_state, 'subdomain', None)}")
+        print("   Call stack:")
+        for line in traceback.format_stack()[-3:-1]:  # Show last 2 relevant frames
+            print(f"     {line.strip()}")
+        router_calls.append(('read', model.__name__, hints))
+        return self._default_db()
+    
+    def db_for_write(self, model, **hints):
+        import traceback
+        print(f"\nüîç db_for_write called for model: {model.__name__}")
+        print(f"   Hints: {hints}")
+        print(f"   Current subdomain: {getattr(local_state, 'subdomain', None)}")
+        print("   Call stack:")
+        for line in traceback.format_stack()[-3:-1]:  # Show last 2 relevant frames
+            print(f"     {line.strip()}")
+        router_calls.append(('write', model.__name__, hints))
+        return self._default_db()
+    
+    def allow_relation(self, obj1, obj2, **hints):
+        return None
+    
+    def allow_migrate(self, db, app_label, model_name=None, **hints):
+        return None
+
+def configure_test_settings():
+    """Configure Django settings for testing"""
+    if not settings.configured:
+        settings.configure(
+            DEBUG=True,
+            DATABASES={
+                'default': {
+                    'ENGINE': 'django.db.backends.sqlite3',
+                    'NAME': ':memory:',
+                }
+            },
+            INSTALLED_APPS=[
+                'django.contrib.contenttypes',
+                'django.contrib.auth',
+                'django.contrib.sessions',
+                'django.contrib.messages',
+            ],
+            DATABASE_ROUTERS=['test_migrate_db_issue.TenantDatabaseRouter'],
+            SECRET_KEY='test-secret-key',
+            USE_TZ=True,
+        )
+        django.setup()
+
+def test_migrate_with_database_param():
+    """Test that migrate command respects database parameter"""
+    print("Testing migrate command with database parameter...")
+    
+    # Clear previous router calls
+    router_calls.clear()
+    
+    # Set tenant context
+    local_state.subdomain = "localhost"
+    
+    try:
+        # Run migrate with explicit database parameter
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        
+        print(f"Router calls made: {len(router_calls)}")
+        for call_type, model_name, hints in router_calls:
+            print(f"  {call_type}: {model_name} with hints: {hints}")
+            
+        # Check if any router calls were made without proper database hints
+        problematic_calls = [
+            call for call in router_calls 
+            if call[0] == 'read' and 'instance' not in call[2] and 'using' not in call[2]
+        ]
+        
+        if problematic_calls:
+            print(f"\n‚ùå ISSUE REPRODUCED: Found {len(problematic_calls)} problematic router calls:")
+            for call in problematic_calls:
+                print(f"  {call}")
+            return True
+        else:
+            print("\n‚úÖ No problematic router calls found")
+            return False
+            
+    except Exception as e:
+        print(f"Error during migration: {e}")
+        return False
+    finally:
+        # Clear tenant context
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+
+if __name__ == '__main__':
+    configure_test_settings()
+    issue_reproduced = test_migrate_with_database_param()
+    sys.exit(1 if issue_reproduced else 0)

2026-01-06 15:34:41,609 - INFO - ------------------------------
2026-01-06 15:34:41,609 - INFO - END Runtime Completion Fn
2026-01-06 15:34:41,609 - INFO - ------------------------------
2026-01-06 15:34:41,609 - INFO - Got git diff for instance django__django-16400:
--------
diff --git a/django/contrib/auth/management/__init__.py b/django/contrib/auth/management/__init__.py
index 0b5a982617..d36f6a99df 100644
--- a/django/contrib/auth/management/__init__.py
+++ b/django/contrib/auth/management/__init__.py
@@ -79,7 +79,8 @@ def create_permissions(
         ctype = ContentType.objects.db_manager(using).get_for_model(
             klass, for_concrete_model=False
         )
-
+        # Ensure the ContentType has the correct database state
+        ctype._state.db = using
         ctypes.add(ctype)
         for perm in _get_all_permissions(klass._meta):
             searched_perms.append((ctype, perm))
@@ -100,6 +101,8 @@ def create_permissions(
         for ct, (codename, name) in searched_perms
         if (ct.pk, codename) not in all_perms
     ]
+    # Create permissions using the specified database to ensure
+    # foreign key assignments respect the database parameter
     Permission.objects.using(using).bulk_create(perms)
     if verbosity >= 2:
         for perm in perms:
diff --git a/django/db/models/fields/related_descriptors.py b/django/db/models/fields/related_descriptors.py
index 422b08e6ca..c914a36805 100644
--- a/django/db/models/fields/related_descriptors.py
+++ b/django/db/models/fields/related_descriptors.py
@@ -274,13 +274,21 @@ class ForwardManyToOneDescriptor:
             )
         elif value is not None:
             if instance._state.db is None:
-                instance._state.db = router.db_for_write(
-                    instance.__class__, instance=value
-                )
+                # If the related value has a database set, use that for routing
+                if value._state.db is not None:
+                    instance._state.db = value._state.db
+                else:
+                    instance._state.db = router.db_for_write(
+                        instance.__class__, instance=value
+                    )
             if value._state.db is None:
-                value._state.db = router.db_for_write(
-                    value.__class__, instance=instance
-                )
+                # If the instance has a database set, use that for routing
+                if instance._state.db is not None:
+                    value._state.db = instance._state.db
+                else:
+                    value._state.db = router.db_for_write(
+                        value.__class__, instance=instance
+                    )
             if not router.allow_relation(value, instance):
                 raise ValueError(
                     'Cannot assign "%r": the current database router prevents this '
diff --git a/test_comprehensive_migrate.py b/test_comprehensive_migrate.py
new file mode 100644
index 0000000000..28219ca70d
--- /dev/null
+++ b/test_comprehensive_migrate.py
@@ -0,0 +1,161 @@
+#!/usr/bin/env python
+"""
+Comprehensive test for the migrate command database parameter fix.
+"""
+import os
+import sys
+import tempfile
+import shutil
+from threading import local
+
+# Add Django to path
+sys.path.insert(0, '/workspace/django__django__4.2')
+
+# Set up Django settings
+os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'test_settings')
+
+# Create test settings
+import django
+from django.conf import settings
+from django.core.management import execute_from_command_line
+from django.apps import apps
+
+# Global state to track router calls
+router_calls = []
+
+class InvalidTenantException(Exception):
+    pass
+
+local_state = local()
+
+class TenantDatabaseRouter:
+    """Custom DB router that tracks calls and requires tenant context"""
+    
+    def _default_db(self):
+        subdomain = getattr(local_state, "subdomain", None)
+        if subdomain is not None and subdomain in {"localhost", "tenant_1"}:
+            return "default"
+        else:
+            raise InvalidTenantException(f"No tenant context: subdomain={subdomain}")
+    
+    def db_for_read(self, model, **hints):
+        router_calls.append(('read', model.__name__, hints))
+        return self._default_db()
+    
+    def db_for_write(self, model, **hints):
+        router_calls.append(('write', model.__name__, hints))
+        return self._default_db()
+    
+    def allow_relation(self, obj1, obj2, **hints):
+        return None
+    
+    def allow_migrate(self, db, app_label, model_name=None, **hints):
+        return None
+
+def configure_test_settings():
+    """Configure Django settings for testing"""
+    if not settings.configured:
+        settings.configure(
+            DEBUG=True,
+            DATABASES={
+                'default': {
+                    'ENGINE': 'django.db.backends.sqlite3',
+                    'NAME': ':memory:',
+                }
+            },
+            INSTALLED_APPS=[
+                'django.contrib.contenttypes',
+                'django.contrib.auth',
+                'django.contrib.sessions',
+                'django.contrib.messages',
+            ],
+            DATABASE_ROUTERS=['test_comprehensive_migrate.TenantDatabaseRouter'],
+            SECRET_KEY='test-secret-key',
+            USE_TZ=True,
+        )
+        django.setup()
+
+def test_migrate_scenarios():
+    """Test various migrate scenarios"""
+    print("Testing comprehensive migrate scenarios...")
+    
+    test_results = []
+    
+    # Test 1: Migrate with database parameter and tenant context
+    print("\n1. Testing migrate with --database parameter and tenant context...")
+    router_calls.clear()
+    local_state.subdomain = "localhost"
+    
+    try:
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        print("‚úÖ SUCCESS: Migrate completed without router errors")
+        test_results.append(("migrate_with_db_param", True, len(router_calls)))
+    except Exception as e:
+        print(f"‚ùå FAILED: {e}")
+        test_results.append(("migrate_with_db_param", False, len(router_calls)))
+    finally:
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+    
+    # Test 2: Migrate without tenant context (should fail)
+    print("\n2. Testing migrate without tenant context (should fail)...")
+    router_calls.clear()
+    
+    try:
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        print("‚ùå UNEXPECTED: Migrate should have failed without tenant context")
+        test_results.append(("migrate_without_context", False, len(router_calls)))
+    except InvalidTenantException as e:
+        print(f"‚úÖ EXPECTED: Migrate failed as expected: {e}")
+        test_results.append(("migrate_without_context", True, len(router_calls)))
+    except Exception as e:
+        print(f"‚ùå UNEXPECTED ERROR: {e}")
+        test_results.append(("migrate_without_context", False, len(router_calls)))
+    
+    # Test 3: Test that permissions are actually created
+    print("\n3. Testing that permissions are created correctly...")
+    try:
+        from django.contrib.auth.models import Permission
+        from django.contrib.contenttypes.models import ContentType
+        
+        # Set tenant context
+        local_state.subdomain = "localhost"
+        
+        # Count permissions
+        permission_count = Permission.objects.using('default').count()
+        contenttype_count = ContentType.objects.using('default').count()
+        
+        print(f"‚úÖ SUCCESS: Found {permission_count} permissions and {contenttype_count} content types")
+        test_results.append(("permissions_created", True, permission_count))
+        
+    except Exception as e:
+        print(f"‚ùå FAILED: {e}")
+        test_results.append(("permissions_created", False, 0))
+    finally:
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+    
+    return test_results
+
+if __name__ == '__main__':
+    configure_test_settings()
+    results = test_migrate_scenarios()
+    
+    print("\n" + "="*60)
+    print("SUMMARY:")
+    print("="*60)
+    
+    all_passed = True
+    for test_name, passed, details in results:
+        status = "‚úÖ PASS" if passed else "‚ùå FAIL"
+        print(f"{status}: {test_name} (details: {details})")
+        if not passed:
+            all_passed = False
+    
+    print("="*60)
+    if all_passed:
+        print("üéâ ALL TESTS PASSED!")
+        sys.exit(0)
+    else:
+        print("üí• SOME TESTS FAILED!")
+        sys.exit(1)
diff --git a/test_issue_reproduction.py b/test_issue_reproduction.py
new file mode 100644
index 0000000000..4703cafee1
--- /dev/null
+++ b/test_issue_reproduction.py
@@ -0,0 +1,141 @@
+#!/usr/bin/env python
+"""
+Test script that exactly reproduces the issue described in the GitHub issue.
+
+This reproduces the minimal example from the issue description.
+"""
+import os
+import sys
+from threading import local
+
+# Add Django to path
+sys.path.insert(0, '/workspace/django__django__4.2')
+
+# Set up Django settings
+os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'test_settings')
+
+# Create test settings
+import django
+from django.conf import settings
+from django.core.management import execute_from_command_line
+
+# Reproduce the exact code from the issue
+local_state = local()
+
+class InvalidTenantException(Exception):
+    pass
+
+class TenantSubdomainMiddleware:
+    def __init__(self, get_response):
+        self.get_response = get_response
+    def __call__(self, request):
+        ## Get Subdomain
+        host = request.get_host().split(":")[0]
+        local_state.subdomain = (
+            # We assume single level of subdomain : app.service.com 
+            # HOST_IP : used to for local dev. 
+            host if host in ["127.0.0.1", "localhost"] else host.split(".")[0]
+        )
+        response = self.get_response(request)
+        return response
+
+class TenantDatabaseRouter:
+    def _default_db(self):
+        subdomain = getattr(local_state, "subdomain", None)
+        if subdomain is not None and subdomain in {"localhost", "tenant_1"}:
+            return "default"
+        else:
+            raise InvalidTenantException()
+    
+    def db_for_read(self, model, **hints):
+        print("read", hints)
+        return self._default_db()
+    
+    def db_for_write(self, model, **hints):
+        print("write", hints)
+        return self._default_db()
+    
+    def allow_relation(self, obj1, obj2, **hints):
+        return None
+    
+    def allow_migrate(self, db, app_label, model_name=None, **hints):
+        return None
+
+def configure_test_settings():
+    """Configure Django settings exactly as in the issue"""
+    if not settings.configured:
+        settings.configure(
+            DEBUG=True,
+            DATABASES={
+                'default': {
+                    'ENGINE': 'django.db.backends.sqlite3',
+                    'NAME': ':memory:',
+                }
+            },
+            INSTALLED_APPS=[
+                'django.contrib.contenttypes',
+                'django.contrib.auth',
+                'django.contrib.sessions',
+                'django.contrib.messages',
+            ],
+            MIDDLEWARE=[
+                "test_issue_reproduction.TenantSubdomainMiddleware",
+                "django.middleware.security.SecurityMiddleware",
+            ],
+            TENANT_MAP = {"localhost":"default", "tenant_1":"default"},
+            DATABASE_ROUTERS = ["test_issue_reproduction.TenantDatabaseRouter"],
+            SECRET_KEY='test-secret-key',
+            USE_TZ=True,
+        )
+        django.setup()
+
+def test_issue_reproduction():
+    """Test the exact scenario from the issue"""
+    print("Reproducing the exact issue scenario...")
+    print("="*60)
+    
+    # Set tenant context as would be done by middleware
+    local_state.subdomain = "localhost"
+    
+    try:
+        print("Running: python manage.py migrate --database=default")
+        print("Expected: Should complete without 'read {}' being printed before exception")
+        print("-" * 60)
+        
+        # Run migrate with database parameter
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        
+        print("-" * 60)
+        print("‚úÖ SUCCESS: Migration completed without the problematic 'read {}' output!")
+        print("‚úÖ The database parameter is now properly respected!")
+        return True
+        
+    except InvalidTenantException:
+        print("-" * 60)
+        print("‚ùå FAILED: InvalidTenantException was raised")
+        print("‚ùå This means the database router was called without proper context")
+        return False
+        
+    except Exception as e:
+        print("-" * 60)
+        print(f"‚ùå FAILED: Unexpected error: {e}")
+        return False
+        
+    finally:
+        # Clean up tenant context
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+
+if __name__ == '__main__':
+    configure_test_settings()
+    success = test_issue_reproduction()
+    
+    print("\n" + "="*60)
+    if success:
+        print("üéâ ISSUE FIXED: The migrate command now respects the database parameter!")
+        print("üéâ No more problematic 'read {}' calls without proper database context!")
+    else:
+        print("üí• ISSUE NOT FIXED: The problem still exists")
+    print("="*60)
+    
+    sys.exit(0 if success else 1)
diff --git a/test_migrate_db_issue.py b/test_migrate_db_issue.py
new file mode 100644
index 0000000000..1dfb7aa1bd
--- /dev/null
+++ b/test_migrate_db_issue.py
@@ -0,0 +1,139 @@
+#!/usr/bin/env python
+"""
+Test script to reproduce the migrate command database parameter issue.
+
+The issue: When running migrate with a database parameter, there's a DB read 
+request that runs after the migration which doesn't respect the db param and 
+invokes the db router.
+"""
+import os
+import sys
+import tempfile
+import shutil
+from threading import local
+
+# Add Django to path
+sys.path.insert(0, '/workspace/django__django__4.2')
+
+# Set up Django settings
+os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'test_settings')
+
+# Create test settings
+import django
+from django.conf import settings
+from django.core.management import execute_from_command_line
+
+# Global state to track router calls
+router_calls = []
+
+class InvalidTenantException(Exception):
+    pass
+
+local_state = local()
+
+class TenantDatabaseRouter:
+    """Custom DB router that tracks calls and requires tenant context"""
+    
+    def _default_db(self):
+        subdomain = getattr(local_state, "subdomain", None)
+        if subdomain is not None and subdomain in {"localhost", "tenant_1"}:
+            return "default"
+        else:
+            raise InvalidTenantException(f"No tenant context: subdomain={subdomain}")
+    
+    def db_for_read(self, model, **hints):
+        import traceback
+        print(f"\nüîç db_for_read called for model: {model.__name__}")
+        print(f"   Hints: {hints}")
+        print(f"   Current subdomain: {getattr(local_state, 'subdomain', None)}")
+        print("   Call stack:")
+        for line in traceback.format_stack()[-3:-1]:  # Show last 2 relevant frames
+            print(f"     {line.strip()}")
+        router_calls.append(('read', model.__name__, hints))
+        return self._default_db()
+    
+    def db_for_write(self, model, **hints):
+        import traceback
+        print(f"\nüîç db_for_write called for model: {model.__name__}")
+        print(f"   Hints: {hints}")
+        print(f"   Current subdomain: {getattr(local_state, 'subdomain', None)}")
+        print("   Call stack:")
+        for line in traceback.format_stack()[-3:-1]:  # Show last 2 relevant frames
+            print(f"     {line.strip()}")
+        router_calls.append(('write', model.__name__, hints))
+        return self._default_db()
+    
+    def allow_relation(self, obj1, obj2, **hints):
+        return None
+    
+    def allow_migrate(self, db, app_label, model_name=None, **hints):
+        return None
+
+def configure_test_settings():
+    """Configure Django settings for testing"""
+    if not settings.configured:
+        settings.configure(
+            DEBUG=True,
+            DATABASES={
+                'default': {
+                    'ENGINE': 'django.db.backends.sqlite3',
+                    'NAME': ':memory:',
+                }
+            },
+            INSTALLED_APPS=[
+                'django.contrib.contenttypes',
+                'django.contrib.auth',
+                'django.contrib.sessions',
+                'django.contrib.messages',
+            ],
+            DATABASE_ROUTERS=['test_migrate_db_issue.TenantDatabaseRouter'],
+            SECRET_KEY='test-secret-key',
+            USE_TZ=True,
+        )
+        django.setup()
+
+def test_migrate_with_database_param():
+    """Test that migrate command respects database parameter"""
+    print("Testing migrate command with database parameter...")
+    
+    # Clear previous router calls
+    router_calls.clear()
+    
+    # Set tenant context
+    local_state.subdomain = "localhost"
+    
+    try:
+        # Run migrate with explicit database parameter
+        execute_from_command_line(['manage.py', 'migrate', '--database=default', '--verbosity=0'])
+        
+        print(f"Router calls made: {len(router_calls)}")
+        for call_type, model_name, hints in router_calls:
+            print(f"  {call_type}: {model_name} with hints: {hints}")
+            
+        # Check if any router calls were made without proper database hints
+        problematic_calls = [
+            call for call in router_calls 
+            if call[0] == 'read' and 'instance' not in call[2] and 'using' not in call[2]
+        ]
+        
+        if problematic_calls:
+            print(f"\n‚ùå ISSUE REPRODUCED: Found {len(problematic_calls)} problematic router calls:")
+            for call in problematic_calls:
+                print(f"  {call}")
+            return True
+        else:
+            print("\n‚úÖ No problematic router calls found")
+            return False
+            
+    except Exception as e:
+        print(f"Error during migration: {e}")
+        return False
+    finally:
+        # Clear tenant context
+        if hasattr(local_state, 'subdomain'):
+            delattr(local_state, 'subdomain')
+
+if __name__ == '__main__':
+    configure_test_settings()
+    issue_reproduced = test_migrate_with_database_param()
+    sys.exit(1 if issue_reproduced else 0)
--------
2026-01-06 15:34:45,645 - INFO - Using instance container image: docker.io/swebench/sweb.eval.x86_64.matplotlib_1776_matplotlib-25433:latest. Please make sure this image exists. Submit an issue on https://github.com/OpenHands/OpenHands if you run into any issues.
2026-01-06 15:34:45,648 - INFO - Resource mapping for princeton-nlp__SWE-bench_Lite-test not found.
2026-01-06 15:34:45,649 - INFO - Logging LLM completions for instance matplotlib__matplotlib-25433 to ./continuum32/princeton-nlp__SWE-bench_Lite-test/CodeActAgent/GLM-4.6-FP8_maxiter_135/llm_completions/matplotlib__matplotlib-25433
2026-01-06 15:34:45,650 - INFO - Config file not found: config.toml. Error: [Errno 2] No such file or directory: 'config.toml'
2026-01-06 15:34:45,650 - INFO - Config file not found: [Errno 2] No such file or directory: 'config.toml'. Toml values have not been applied.
