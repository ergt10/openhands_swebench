2026-01-06 15:04:27,442 - INFO - [LLM registry 387ecdb0-110b-4497-8375-589504d941d7]: Registering service for agent
2026-01-06 15:04:27,478 - INFO - Building image: ghcr.io/openhands/runtime:oh_v1.0.0_cautd9fj6atkyrau_v008aov5t6vw3gr5
2026-01-06 15:15:31,898 - INFO - Image [ghcr.io/openhands/runtime:oh_v1.0.0_cautd9fj6atkyrau_v008aov5t6vw3gr5] build finished.
2026-01-06 15:15:31,905 - INFO - Re-tagged image [ghcr.io/openhands/runtime:oh_v1.0.0_cautd9fj6atkyrau_v008aov5t6vw3gr5] with more generic tag [oh_v1.0.0_cautd9fj6atkyrau]
2026-01-06 15:15:31,906 - INFO - Image ghcr.io/openhands/runtime with tags [oh_v1.0.0_cautd9fj6atkyrau_v008aov5t6vw3gr5, oh_v1.0.0_cautd9fj6atkyrau] built successfully
2026-01-06 15:15:31,979 - INFO - [runtime aa6d140e-3a62-4c-09f06bbee044c1f] Starting runtime with image: ghcr.io/openhands/runtime:oh_v1.0.0_cautd9fj6atkyrau_v008aov5t6vw3gr5
2026-01-06 15:15:32,075 - INFO - [runtime aa6d140e-3a62-4c-09f06bbee044c1f] Starting server with command: ['/openhands/micromamba/bin/micromamba', 'run', '-n', 'openhands', 'poetry', 'run', 'python', '-u', '-m', 'openhands.runtime.action_execution_server', '33066', '--working-dir', '/workspace', '--plugins', 'agent_skills', 'jupyter', '--username', 'root', '--user-id', '0', '--no-enable-browser']
2026-01-06 15:15:33,452 - INFO - [runtime aa6d140e-3a62-4c-09f06bbee044c1f] Container started: openhands-runtime-aa6d140e-3a62-4c-09f06bbee044c1f. VSCode URL: None
2026-01-06 15:15:33,452 - INFO - [runtime aa6d140e-3a62-4c-09f06bbee044c1f] Waiting for client to become ready at http://localhost:33066...
2026-01-06 15:16:03,525 - INFO - [runtime aa6d140e-3a62-4c-09f06bbee044c1f] Runtime is ready.
2026-01-06 15:16:06,642 - INFO - Successfully configured git: name=openhands, email=openhands@all-hands.dev
2026-01-06 15:16:06,644 - INFO - ------------------------------
2026-01-06 15:16:06,644 - INFO - BEGIN Runtime Initialization Fn
2026-01-06 15:16:06,644 - INFO - ------------------------------
2026-01-06 15:16:06,644 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
echo 'export SWE_INSTANCE_ID=django__django-15213' >> ~/.bashrc && echo 'export PIP_CACHE_DIR=~/.cache/pip' >> ~/.bashrc && echo "alias git='git --no-pager'" >> ~/.bashrc && git config --global core.pager "" && git config --global diff.binary false
2026-01-06 15:16:07,264 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:07,264 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
export USER=$(whoami); echo USER=${USER} 
2026-01-06 15:16:07,883 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
USER=root
[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:07,883 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
mkdir -p /swe_util/eval_data/instances
2026-01-06 15:16:08,503 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:08,508 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
cat ~/.bashrc
2026-01-06 15:16:09,127 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
source /opt/miniconda3/etc/profile.d/conda.sh && conda activate testbed

. "/openhands/bin/env"
export PATH="/usr/bin:/bin:/usr/sbin:/sbin:/openhands/micromamba/bin:$PATH"
export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
eval "$(/openhands/micromamba/bin/micromamba shell hook --shell bash)"
micromamba activate openhands 2>/dev/null || true
export ENABLE_AUTO_LINT=true
export NO_CHANGE_TIMEOUT_SECONDS=30
export OPENHANDS_EVAL_INSTANCE_ID=django__django-15213
export OPENHANDS_EVAL_JOB_ID=3842596609
export OPENHANDS_TIMING_DIR=./continuum32/princeton-nlp__SWE-bench_Lite-test/CodeActAgent/GLM-4.6-FP8_maxiter_135/timing
export SWE_INSTANCE_ID=django__django-15213
export PIP_CACHE_DIR=~/.cache/pip
alias git='git --no-pager'
[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:09,128 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
source ~/.bashrc
2026-01-06 15:16:09,750 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace",
  "py_interpreter_path": "/openhands/micromamba/envs/openhands/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /openhands/micromamba/envs/openhands/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:09,750 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
source /swe_util/instance_swe_entry.sh
2026-01-06 15:16:11,378 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
WORKSPACE_NAME: django__django__4.1
[The command completed with exit code 0.]
[Current working directory: /workspace]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:11,378 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
cd /workspace/django__django__4.1
2026-01-06 15:16:11,998 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:11,998 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git reset --hard
2026-01-06 15:16:14,127 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
Updating files: 100% (6584/6584), done.
HEAD is now at 03cadb912c Removed a Python error message dependency in test_questioner_no_default_bad_user_entry_code().
[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:14,127 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
for remote_name in $(git remote); do git remote remove "${remote_name}"; done
2026-01-06 15:16:14,747 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:14,748 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
which python
2026-01-06 15:16:15,367 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
/opt/miniconda3/envs/testbed/bin/python
[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:16:15,367 - INFO - ------------------------------
2026-01-06 15:16:15,367 - INFO - END Runtime Initialization Fn
2026-01-06 15:16:15,368 - INFO - ------------------------------
2026-01-06 15:16:15,370 - INFO - [LLM registry a663e1be-0d03-45ef-adfe-73d22927e97a]: Registering service for agent
2026-01-06 15:16:15,381 - INFO - [runtime aa6d140e-3a62-4c-09f06bbee044c1f] Selected repo: None, loading microagents from /workspace/.openhands/microagents (inside runtime)
2026-01-06 15:16:15,384 - INFO - [runtime aa6d140e-3a62-4c-09f06bbee044c1f] Attempting to list files in repository microagents directory: /workspace/.openhands/microagents
2026-01-06 15:16:15,385 - INFO - Loading user workspace microagents: []
2026-01-06 15:16:15,386 - INFO - AgentController aa6d140e-3a62-4c-09f06bbee044c1f - created new state. start_id: 0
2026-01-06 15:16:15,391 - INFO - [Agent Controller aa6d140e-3a62-4c-09f06bbee044c1f] Setting agent(CodeActAgent) state from AgentState.LOADING to AgentState.RUNNING
2026-01-06 15:16:15,394 - INFO - Saved conversation stats
2026-01-06 15:28:11,569 - INFO - [Agent Controller aa6d140e-3a62-4c-09f06bbee044c1f] Setting agent(CodeActAgent) state from AgentState.RUNNING to AgentState.FINISHED
2026-01-06 15:28:11,572 - INFO - Saved conversation stats
2026-01-06 15:28:12,117 - INFO - ------------------------------
2026-01-06 15:28:12,117 - INFO - BEGIN Runtime Completion Fn
2026-01-06 15:28:12,117 - INFO - ------------------------------
2026-01-06 15:28:12,118 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
cd /workspace/django__django__4.1
2026-01-06 15:28:12,738 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:28:12,738 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git config --global core.pager ""
2026-01-06 15:28:13,358 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:28:13,358 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
find . -type d -name .git -not -path "./.git"
2026-01-06 15:28:13,987 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:28:13,989 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git add -A
2026-01-06 15:28:14,609 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:28:14,610 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
for file in $(git status --porcelain | grep -E "^(M| M|\?\?|A| A)" | cut -c4-); do
        if [ -f "$file" ] && (file "$file" | grep -q "executable" || git check-attr binary "$file" | grep -q "binary: set"); then
            git rm -f "$file" 2>/dev/null || rm -f "$file"
            echo "Removed: $file"
        fi
    done
2026-01-06 15:28:15,234 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--
bash: file: command not found
bash: file: command not found
bash: file: command not found
bash: file: command not found
bash: file: command not found
bash: file: command not found
bash: file: command not found
bash: file: command not found
[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:28:15,235 - INFO - **CmdRunAction (source=None, is_input=False)**
COMMAND:
git diff --no-color --cached 03cadb912c78b769d6bf4a943a2a35fc1d952960 > patch.diff
2026-01-06 15:28:15,854 - INFO - **CmdOutputObservation (source=None, exit code=0, metadata={
  "exit_code": 0,
  "pid": -1,
  "username": "root",
  "hostname": "be3f689b7903",
  "working_dir": "/workspace/django__django__4.1",
  "py_interpreter_path": "/opt/miniconda3/envs/testbed/bin/python",
  "prefix": "",
  "suffix": "\n[The command completed with exit code 0.]"
})**
--BEGIN AGENT OBSERVATION--

[The command completed with exit code 0.]
[Current working directory: /workspace/django__django__4.1]
[Python interpreter: /opt/miniconda3/envs/testbed/bin/python]
[Command finished with exit code 0]
--END AGENT OBSERVATION--
2026-01-06 15:28:15,854 - INFO - FileReadAction(path='patch.diff', start=0, end=-1, thought='', action=<ActionType.READ: 'read'>, security_risk=<ActionSecurityRisk.UNKNOWN: -1>, impl_source=<FileReadSource.DEFAULT: 'default'>, view_range=None)
2026-01-06 15:28:15,858 - INFO - [Read from /workspace/django__django__4.1/patch.diff is successful.]
diff --git a/comprehensive_test.py b/comprehensive_test.py
new file mode 100644
index 0000000000..3ba9ebb78e
--- /dev/null
+++ b/comprehensive_test.py
@@ -0,0 +1,99 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField, IntegerField
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def test_comprehensive_cases():
+    """Test comprehensive cases for the ExpressionWrapper fix"""
+    
+    print("=== Comprehensive ExpressionWrapper Tests ===")
+    
+    test_cases = [
+        # (description, expression, expected_pattern)
+        ("Q(pk__in=[])", Q(pk__in=[]), r"SELECT 0 AS"),
+        ("~Q(pk__in=[])", ~Q(pk__in=[]), r"SELECT 1 AS"),  # SQLite uses 1 for True
+        ("Q(name__in=[])", Q(name__in=[]), r"SELECT 0 AS"),
+        ("~Q(name__in=[])", ~Q(name__in=[]), r"SELECT 1 AS"),
+        ("Q(pk__in=[]) with IntegerField", Q(pk__in=[]), r"SELECT 0 AS"),  # Should still work
+    ]
+    
+    for description, expression, expected_pattern in test_cases:
+        try:
+            # Test with BooleanField
+            queryset = TestModel.objects.annotate(
+                foo=ExpressionWrapper(expression, output_field=BooleanField())
+            ).values("foo")
+            sql = str(queryset.query)
+            
+            import re
+            if re.search(expected_pattern, sql):
+                print(f"✓ {description}: {sql}")
+            else:
+                print(f"✗ {description}: Expected pattern '{expected_pattern}' but got '{sql}'")
+                
+        except Exception as e:
+            print(f"✗ {description}: Failed with error: {e}")
+    
+    print("\n=== Testing with different output fields ===")
+    
+    # Test with IntegerField
+    try:
+        queryset = TestModel.objects.annotate(
+            foo=ExpressionWrapper(~Q(pk__in=[]), output_field=IntegerField())
+        ).values("foo")
+        sql = str(queryset.query)
+        print(f"✓ ~Q(pk__in=[]) with IntegerField: {sql}")
+    except Exception as e:
+        print(f"✗ ~Q(pk__in=[]) with IntegerField: Failed with error: {e}")
+    
+    print("\n=== Testing complex Q objects ===")
+    
+    complex_cases = [
+        ("Q(pk__in=[]) | Q(name='test')", Q(pk__in=[]) | Q(name='test')),
+        ("~Q(pk__in=[]) & Q(name='test')", ~Q(pk__in=[]) & Q(name='test')),
+        ("Q(pk__in=[]) & ~Q(name__in=[])", Q(pk__in=[]) & ~Q(name__in=[])),
+    ]
+    
+    for description, expression in complex_cases:
+        try:
+            queryset = TestModel.objects.annotate(
+                foo=ExpressionWrapper(expression, output_field=BooleanField())
+            ).values("foo")
+            sql = str(queryset.query)
+            print(f"✓ {description}: {sql}")
+        except Exception as e:
+            print(f"✗ {description}: Failed with error: {e}")
+
+if __name__ == "__main__":
+    test_comprehensive_cases()
diff --git a/debug_compilation.py b/debug_compilation.py
new file mode 100644
index 0000000000..f7ff436fe0
--- /dev/null
+++ b/debug_compilation.py
@@ -0,0 +1,77 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_compilation_process():
+    """Debug the compilation process step by step"""
+    
+    print("=== Debugging compilation process ===")
+    
+    # Create the ExpressionWrapper
+    ew = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper: {ew}")
+    print(f"empty_result_set_value: {ew.empty_result_set_value}")
+    
+    # Create a query and compiler
+    from django.db.models.sql.query import Query
+    from django.db.models.sql.compiler import SQLCompiler
+    from django.db import connection
+    
+    query = Query(TestModel)
+    compiler = SQLCompiler(query, connection, 'default')
+    
+    print(f"\n=== Testing direct compilation ===")
+    
+    try:
+        sql, params = compiler.compile(ew)
+        print(f"Compiled SQL: {sql}, params: {params}")
+    except EmptyResultSet as e:
+        print(f"EmptyResultSet raised: {e}")
+        # Check what the compiler would do
+        empty_result_set_value = getattr(ew, 'empty_result_set_value', NotImplemented)
+        print(f"empty_result_set_value: {empty_result_set_value}")
+        if empty_result_set_value is NotImplemented:
+            print("Would use default: '0'")
+        else:
+            print(f"Would use: {empty_result_set_value}")
+    except Exception as e:
+        print(f"Other error: {e}")
+        import traceback
+        traceback.print_exc()
+
+if __name__ == "__main__":
+    debug_compilation_process()
diff --git a/debug_fix.py b/debug_fix.py
new file mode 100644
index 0000000000..8a0d0c015e
--- /dev/null
+++ b/debug_fix.py
@@ -0,0 +1,74 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_expression_wrapper():
+    """Debug ExpressionWrapper after the fix"""
+    
+    print("=== Debugging ExpressionWrapper after fix ===")
+    
+    # Test ExpressionWrapper properties
+    ew1 = ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+    ew2 = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper(Q(pk__in=[])).empty_result_set_value = {ew1.empty_result_set_value}")
+    print(f"ExpressionWrapper(~Q(pk__in=[])).empty_result_set_value = {ew2.empty_result_set_value}")
+    
+    print(f"Q(pk__in=[]).negated = {Q(pk__in=[]).negated}")
+    print(f"~Q(pk__in=[]).negated = {~Q(pk__in=[]).negated}")
+    
+    # Test the actual query generation
+    print("\n=== Testing query generation ===")
+    
+    try:
+        queryset1 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql1 = str(queryset1.query)
+        print(f"✓ Q(pk__in=[]) works: {sql1}")
+    except Exception as e:
+        print(f"✗ Q(pk__in=[]) failed: {e}")
+    
+    try:
+        queryset2 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql2 = str(queryset2.query)
+        print(f"✓ ~Q(pk__in=[]) works: {sql2}")
+    except Exception as e:
+        print(f"✗ ~Q(pk__in=[]) failed: {e}")
+
+if __name__ == "__main__":
+    debug_expression_wrapper()
diff --git a/debug_negation.py b/debug_negation.py
new file mode 100644
index 0000000000..fc80893ef7
--- /dev/null
+++ b/debug_negation.py
@@ -0,0 +1,89 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_q_objects():
+    """Debug Q objects to understand negation behavior"""
+    
+    print("=== Debugging Q objects ===")
+    
+    # Test Q object properties
+    q1 = Q(pk__in=[])
+    q2 = ~Q(pk__in=[])
+    
+    print(f"Q(pk__in=[]): negated={q1.negated}")
+    print(f"~Q(pk__in=[]): negated={q2.negated}")
+    
+    # Test empty_result_set_value
+    print(f"Q(pk__in=[]).empty_result_set_value = {getattr(q1, 'empty_result_set_value', 'Not defined')}")
+    print(f"~Q(pk__in=[]).empty_result_set_value = {getattr(q2, 'empty_result_set_value', 'Not defined')}")
+    
+    # Test ExpressionWrapper properties
+    ew1 = ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+    ew2 = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper(Q(pk__in=[])).empty_result_set_value = {ew1.empty_result_set_value}")
+    print(f"ExpressionWrapper(~Q(pk__in=[])).empty_result_set_value = {ew2.empty_result_set_value}")
+    
+    # Test what happens when we try to compile the inner expressions
+    from django.db.models.sql.compiler import SQLCompiler
+    from django.db import connection
+    
+    # Create a dummy query
+    from django.db.models.sql.query import Query
+    query = Query(TestModel)
+    compiler = SQLCompiler(query, connection, 'default')
+    
+    print("\n=== Testing compilation ===")
+    
+    try:
+        result1 = compiler.compile(q1)
+        print(f"Q(pk__in=[]) compiles to: {result1}")
+    except EmptyResultSet as e:
+        print(f"Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"Q(pk__in=[]) raises other error: {e}")
+    
+    try:
+        result2 = compiler.compile(q2)
+        print(f"~Q(pk__in=[]) compiles to: {result2}")
+    except EmptyResultSet as e:
+        print(f"~Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"~Q(pk__in=[]) raises other error: {e}")
+
+if __name__ == "__main__":
+    debug_q_objects()
diff --git a/debug_query_generation.py b/debug_query_generation.py
new file mode 100644
index 0000000000..792954856b
--- /dev/null
+++ b/debug_query_generation.py
@@ -0,0 +1,75 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_query_generation():
+    """Debug the actual query generation process"""
+    
+    print("=== Debugging query generation ===")
+    
+    # Create the ExpressionWrapper
+    ew = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper: {ew}")
+    print(f"empty_result_set_value: {ew.empty_result_set_value}")
+    
+    # Create the actual query
+    queryset = TestModel.objects.annotate(foo=ew).values("foo")
+    
+    print(f"\n=== Query details ===")
+    print(f"Query: {queryset.query}")
+    
+    # Let's manually step through the compilation process
+    from django.db.models.sql.compiler import SQLCompiler
+    from django.db import connection
+    
+    query = queryset.query
+    compiler = SQLCompiler(query, connection, 'default')
+    
+    print(f"\n=== Manual compilation ===")
+    
+    # Get the select clause
+    select, klass_info, annotations = compiler.get_select()
+    
+    print(f"Select clause: {select}")
+    for col, (sql, params), alias in select:
+        print(f"  Column: {col}")
+        print(f"  SQL: '{sql}', params: {params}")
+        print(f"  Alias: {alias}")
+        print(f"  empty_result_set_value: {getattr(col, 'empty_result_set_value', 'Not defined')}")
+
+if __name__ == "__main__":
+    debug_query_generation()
diff --git a/debug_resolution.py b/debug_resolution.py
new file mode 100644
index 0000000000..f0396727af
--- /dev/null
+++ b/debug_resolution.py
@@ -0,0 +1,75 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_q_resolution():
+    """Debug Q object resolution"""
+    
+    print("=== Debugging Q object resolution ===")
+    
+    # Create a query
+    from django.db.models.sql.query import Query
+    from django.db import connection
+    
+    query = Query(TestModel)
+    
+    # Test Q object resolution
+    q1 = Q(pk__in=[])
+    q2 = ~Q(pk__in=[])
+    
+    print(f"Q(pk__in=[]): negated={q1.negated}")
+    print(f"~Q(pk__in=[]): negated={q2.negated}")
+    
+    try:
+        resolved1 = q1.resolve_expression(query)
+        print(f"Q(pk__in=[]) resolves to: {type(resolved1)} - {resolved1}")
+        print(f"  empty_result_set_value: {getattr(resolved1, 'empty_result_set_value', 'Not defined')}")
+    except EmptyResultSet as e:
+        print(f"Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"Q(pk__in=[]) raises other error: {e}")
+    
+    try:
+        resolved2 = q2.resolve_expression(query)
+        print(f"~Q(pk__in=[]) resolves to: {type(resolved2)} - {resolved2}")
+        print(f"  empty_result_set_value: {getattr(resolved2, 'empty_result_set_value', 'Not defined')}")
+    except EmptyResultSet as e:
+        print(f"~Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"~Q(pk__in=[]) raises other error: {e}")
+
+if __name__ == "__main__":
+    debug_q_resolution()
diff --git a/django/db/models/expressions.py b/django/db/models/expressions.py
index 8642e1f151..e89aeeb99b 100644
--- a/django/db/models/expressions.py
+++ b/django/db/models/expressions.py
@@ -978,7 +978,34 @@ class ExpressionWrapper(SQLiteNumericMixin, Expression):
         # `expression` must be included in the GROUP BY clause.
         return super().get_group_by_cols()
 
+    @cached_property
+    def empty_result_set_value(self):
+        """
+        Return the appropriate value when the wrapped expression results in an empty set.
+        For boolean expressions, this depends on whether the expression is negated.
+        """
+        # If the wrapped expression is a Q object, check if it's negated
+        if hasattr(self.expression, 'negated') and bool(self.expression.negated):
+            # For negated Q objects that would raise EmptyResultSet (like ~Q(pk__in=[])),
+            # the result should be True for boolean fields (since NOT (empty set) = all rows = True)
+            if isinstance(self.output_field, fields.BooleanField):
+                return True
+            # For other field types, use 1 as a reasonable default for "true" values
+            return 1
+        return NotImplemented
+
     def as_sql(self, compiler, connection):
+        # If the expression is a Q object, it needs to be resolved first
+        if hasattr(self.expression, 'resolve_expression'):
+            resolved_expression = self.expression.resolve_expression(compiler.query)
+            sql, params = compiler.compile(resolved_expression)
+            # Handle the case where a negated Q with empty IN returns empty SQL
+            if not sql and hasattr(self.expression, 'negated') and bool(self.expression.negated):
+                # This is likely a negated Q with empty IN, use the empty_result_set_value
+                empty_result_set_value = getattr(self, 'empty_result_set_value', NotImplemented)
+                if empty_result_set_value is not NotImplemented:
+                    return compiler.compile(Value(empty_result_set_value))
+            return sql, params
         return compiler.compile(self.expression)
 
     def __repr__(self):
diff --git a/reproduce_issue.py b/reproduce_issue.py
new file mode 100644
index 0000000000..655d7395b9
--- /dev/null
+++ b/reproduce_issue.py
@@ -0,0 +1,88 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+# Create the table
+from django.db import connection
+with connection.schema_editor() as schema_editor:
+    schema_editor.create_model(TestModel)
+
+def test_expression_wrapper_issue():
+    """Test the ExpressionWrapper issue with ~Q(pk__in=[])"""
+    
+    print("=== Testing ExpressionWrapper with Q(pk__in=[]) ===")
+    
+    # Test case 1: ExpressionWrapper(Q(pk__in=[])) - should work
+    try:
+        queryset1 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql1 = str(queryset1.query)
+        print(f"✓ Q(pk__in=[]) works: {sql1}")
+    except Exception as e:
+        print(f"✗ Q(pk__in=[]) failed: {e}")
+    
+    print("\n=== Testing ExpressionWrapper with ~Q(pk__in=[]) ===")
+    
+    # Test case 2: ExpressionWrapper(~Q(pk__in=[])) - should fail
+    try:
+        queryset2 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql2 = str(queryset2.query)
+        print(f"✓ ~Q(pk__in=[]) works: {sql2}")
+    except Exception as e:
+        print(f"✗ ~Q(pk__in=[]) failed: {e}")
+    
+    print("\n=== Testing direct Q objects (for comparison) ===")
+    
+    # Test case 3: Direct Q(pk__in=[]) - should work
+    try:
+        queryset3 = TestModel.objects.filter(Q(pk__in=[]))
+        sql3 = str(queryset3.query)
+        print(f"✓ Direct Q(pk__in=[]) works: {sql3}")
+    except Exception as e:
+        print(f"✗ Direct Q(pk__in=[]) failed: {e}")
+    
+    # Test case 4: Direct ~Q(pk__in=[]) - should work
+    try:
+        queryset4 = TestModel.objects.filter(~Q(pk__in=[]))
+        sql4 = str(queryset4.query)
+        print(f"✓ Direct ~Q(pk__in=[]) works: {sql4}")
+    except Exception as e:
+        print(f"✗ Direct ~Q(pk__in=[]) failed: {e}")
+
+if __name__ == "__main__":
+    test_expression_wrapper_issue()

2026-01-06 15:28:15,859 - INFO - ------------------------------
2026-01-06 15:28:15,859 - INFO - END Runtime Completion Fn
2026-01-06 15:28:15,859 - INFO - ------------------------------
2026-01-06 15:28:15,859 - INFO - Got git diff for instance django__django-15213:
--------
diff --git a/comprehensive_test.py b/comprehensive_test.py
new file mode 100644
index 0000000000..3ba9ebb78e
--- /dev/null
+++ b/comprehensive_test.py
@@ -0,0 +1,99 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField, IntegerField
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def test_comprehensive_cases():
+    """Test comprehensive cases for the ExpressionWrapper fix"""
+    
+    print("=== Comprehensive ExpressionWrapper Tests ===")
+    
+    test_cases = [
+        # (description, expression, expected_pattern)
+        ("Q(pk__in=[])", Q(pk__in=[]), r"SELECT 0 AS"),
+        ("~Q(pk__in=[])", ~Q(pk__in=[]), r"SELECT 1 AS"),  # SQLite uses 1 for True
+        ("Q(name__in=[])", Q(name__in=[]), r"SELECT 0 AS"),
+        ("~Q(name__in=[])", ~Q(name__in=[]), r"SELECT 1 AS"),
+        ("Q(pk__in=[]) with IntegerField", Q(pk__in=[]), r"SELECT 0 AS"),  # Should still work
+    ]
+    
+    for description, expression, expected_pattern in test_cases:
+        try:
+            # Test with BooleanField
+            queryset = TestModel.objects.annotate(
+                foo=ExpressionWrapper(expression, output_field=BooleanField())
+            ).values("foo")
+            sql = str(queryset.query)
+            
+            import re
+            if re.search(expected_pattern, sql):
+                print(f"✓ {description}: {sql}")
+            else:
+                print(f"✗ {description}: Expected pattern '{expected_pattern}' but got '{sql}'")
+                
+        except Exception as e:
+            print(f"✗ {description}: Failed with error: {e}")
+    
+    print("\n=== Testing with different output fields ===")
+    
+    # Test with IntegerField
+    try:
+        queryset = TestModel.objects.annotate(
+            foo=ExpressionWrapper(~Q(pk__in=[]), output_field=IntegerField())
+        ).values("foo")
+        sql = str(queryset.query)
+        print(f"✓ ~Q(pk__in=[]) with IntegerField: {sql}")
+    except Exception as e:
+        print(f"✗ ~Q(pk__in=[]) with IntegerField: Failed with error: {e}")
+    
+    print("\n=== Testing complex Q objects ===")
+    
+    complex_cases = [
+        ("Q(pk__in=[]) | Q(name='test')", Q(pk__in=[]) | Q(name='test')),
+        ("~Q(pk__in=[]) & Q(name='test')", ~Q(pk__in=[]) & Q(name='test')),
+        ("Q(pk__in=[]) & ~Q(name__in=[])", Q(pk__in=[]) & ~Q(name__in=[])),
+    ]
+    
+    for description, expression in complex_cases:
+        try:
+            queryset = TestModel.objects.annotate(
+                foo=ExpressionWrapper(expression, output_field=BooleanField())
+            ).values("foo")
+            sql = str(queryset.query)
+            print(f"✓ {description}: {sql}")
+        except Exception as e:
+            print(f"✗ {description}: Failed with error: {e}")
+
+if __name__ == "__main__":
+    test_comprehensive_cases()
diff --git a/debug_compilation.py b/debug_compilation.py
new file mode 100644
index 0000000000..f7ff436fe0
--- /dev/null
+++ b/debug_compilation.py
@@ -0,0 +1,77 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_compilation_process():
+    """Debug the compilation process step by step"""
+    
+    print("=== Debugging compilation process ===")
+    
+    # Create the ExpressionWrapper
+    ew = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper: {ew}")
+    print(f"empty_result_set_value: {ew.empty_result_set_value}")
+    
+    # Create a query and compiler
+    from django.db.models.sql.query import Query
+    from django.db.models.sql.compiler import SQLCompiler
+    from django.db import connection
+    
+    query = Query(TestModel)
+    compiler = SQLCompiler(query, connection, 'default')
+    
+    print(f"\n=== Testing direct compilation ===")
+    
+    try:
+        sql, params = compiler.compile(ew)
+        print(f"Compiled SQL: {sql}, params: {params}")
+    except EmptyResultSet as e:
+        print(f"EmptyResultSet raised: {e}")
+        # Check what the compiler would do
+        empty_result_set_value = getattr(ew, 'empty_result_set_value', NotImplemented)
+        print(f"empty_result_set_value: {empty_result_set_value}")
+        if empty_result_set_value is NotImplemented:
+            print("Would use default: '0'")
+        else:
+            print(f"Would use: {empty_result_set_value}")
+    except Exception as e:
+        print(f"Other error: {e}")
+        import traceback
+        traceback.print_exc()
+
+if __name__ == "__main__":
+    debug_compilation_process()
diff --git a/debug_fix.py b/debug_fix.py
new file mode 100644
index 0000000000..8a0d0c015e
--- /dev/null
+++ b/debug_fix.py
@@ -0,0 +1,74 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_expression_wrapper():
+    """Debug ExpressionWrapper after the fix"""
+    
+    print("=== Debugging ExpressionWrapper after fix ===")
+    
+    # Test ExpressionWrapper properties
+    ew1 = ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+    ew2 = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper(Q(pk__in=[])).empty_result_set_value = {ew1.empty_result_set_value}")
+    print(f"ExpressionWrapper(~Q(pk__in=[])).empty_result_set_value = {ew2.empty_result_set_value}")
+    
+    print(f"Q(pk__in=[]).negated = {Q(pk__in=[]).negated}")
+    print(f"~Q(pk__in=[]).negated = {~Q(pk__in=[]).negated}")
+    
+    # Test the actual query generation
+    print("\n=== Testing query generation ===")
+    
+    try:
+        queryset1 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql1 = str(queryset1.query)
+        print(f"✓ Q(pk__in=[]) works: {sql1}")
+    except Exception as e:
+        print(f"✗ Q(pk__in=[]) failed: {e}")
+    
+    try:
+        queryset2 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql2 = str(queryset2.query)
+        print(f"✓ ~Q(pk__in=[]) works: {sql2}")
+    except Exception as e:
+        print(f"✗ ~Q(pk__in=[]) failed: {e}")
+
+if __name__ == "__main__":
+    debug_expression_wrapper()
diff --git a/debug_negation.py b/debug_negation.py
new file mode 100644
index 0000000000..fc80893ef7
--- /dev/null
+++ b/debug_negation.py
@@ -0,0 +1,89 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_q_objects():
+    """Debug Q objects to understand negation behavior"""
+    
+    print("=== Debugging Q objects ===")
+    
+    # Test Q object properties
+    q1 = Q(pk__in=[])
+    q2 = ~Q(pk__in=[])
+    
+    print(f"Q(pk__in=[]): negated={q1.negated}")
+    print(f"~Q(pk__in=[]): negated={q2.negated}")
+    
+    # Test empty_result_set_value
+    print(f"Q(pk__in=[]).empty_result_set_value = {getattr(q1, 'empty_result_set_value', 'Not defined')}")
+    print(f"~Q(pk__in=[]).empty_result_set_value = {getattr(q2, 'empty_result_set_value', 'Not defined')}")
+    
+    # Test ExpressionWrapper properties
+    ew1 = ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+    ew2 = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper(Q(pk__in=[])).empty_result_set_value = {ew1.empty_result_set_value}")
+    print(f"ExpressionWrapper(~Q(pk__in=[])).empty_result_set_value = {ew2.empty_result_set_value}")
+    
+    # Test what happens when we try to compile the inner expressions
+    from django.db.models.sql.compiler import SQLCompiler
+    from django.db import connection
+    
+    # Create a dummy query
+    from django.db.models.sql.query import Query
+    query = Query(TestModel)
+    compiler = SQLCompiler(query, connection, 'default')
+    
+    print("\n=== Testing compilation ===")
+    
+    try:
+        result1 = compiler.compile(q1)
+        print(f"Q(pk__in=[]) compiles to: {result1}")
+    except EmptyResultSet as e:
+        print(f"Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"Q(pk__in=[]) raises other error: {e}")
+    
+    try:
+        result2 = compiler.compile(q2)
+        print(f"~Q(pk__in=[]) compiles to: {result2}")
+    except EmptyResultSet as e:
+        print(f"~Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"~Q(pk__in=[]) raises other error: {e}")
+
+if __name__ == "__main__":
+    debug_q_objects()
diff --git a/debug_query_generation.py b/debug_query_generation.py
new file mode 100644
index 0000000000..792954856b
--- /dev/null
+++ b/debug_query_generation.py
@@ -0,0 +1,75 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_query_generation():
+    """Debug the actual query generation process"""
+    
+    print("=== Debugging query generation ===")
+    
+    # Create the ExpressionWrapper
+    ew = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+    
+    print(f"ExpressionWrapper: {ew}")
+    print(f"empty_result_set_value: {ew.empty_result_set_value}")
+    
+    # Create the actual query
+    queryset = TestModel.objects.annotate(foo=ew).values("foo")
+    
+    print(f"\n=== Query details ===")
+    print(f"Query: {queryset.query}")
+    
+    # Let's manually step through the compilation process
+    from django.db.models.sql.compiler import SQLCompiler
+    from django.db import connection
+    
+    query = queryset.query
+    compiler = SQLCompiler(query, connection, 'default')
+    
+    print(f"\n=== Manual compilation ===")
+    
+    # Get the select clause
+    select, klass_info, annotations = compiler.get_select()
+    
+    print(f"Select clause: {select}")
+    for col, (sql, params), alias in select:
+        print(f"  Column: {col}")
+        print(f"  SQL: '{sql}', params: {params}")
+        print(f"  Alias: {alias}")
+        print(f"  empty_result_set_value: {getattr(col, 'empty_result_set_value', 'Not defined')}")
+
+if __name__ == "__main__":
+    debug_query_generation()
diff --git a/debug_resolution.py b/debug_resolution.py
new file mode 100644
index 0000000000..f0396727af
--- /dev/null
+++ b/debug_resolution.py
@@ -0,0 +1,75 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+from django.core.exceptions import EmptyResultSet
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+def debug_q_resolution():
+    """Debug Q object resolution"""
+    
+    print("=== Debugging Q object resolution ===")
+    
+    # Create a query
+    from django.db.models.sql.query import Query
+    from django.db import connection
+    
+    query = Query(TestModel)
+    
+    # Test Q object resolution
+    q1 = Q(pk__in=[])
+    q2 = ~Q(pk__in=[])
+    
+    print(f"Q(pk__in=[]): negated={q1.negated}")
+    print(f"~Q(pk__in=[]): negated={q2.negated}")
+    
+    try:
+        resolved1 = q1.resolve_expression(query)
+        print(f"Q(pk__in=[]) resolves to: {type(resolved1)} - {resolved1}")
+        print(f"  empty_result_set_value: {getattr(resolved1, 'empty_result_set_value', 'Not defined')}")
+    except EmptyResultSet as e:
+        print(f"Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"Q(pk__in=[]) raises other error: {e}")
+    
+    try:
+        resolved2 = q2.resolve_expression(query)
+        print(f"~Q(pk__in=[]) resolves to: {type(resolved2)} - {resolved2}")
+        print(f"  empty_result_set_value: {getattr(resolved2, 'empty_result_set_value', 'Not defined')}")
+    except EmptyResultSet as e:
+        print(f"~Q(pk__in=[]) raises EmptyResultSet: {e}")
+    except Exception as e:
+        print(f"~Q(pk__in=[]) raises other error: {e}")
+
+if __name__ == "__main__":
+    debug_q_resolution()
diff --git a/django/db/models/expressions.py b/django/db/models/expressions.py
index 8642e1f151..e89aeeb99b 100644
--- a/django/db/models/expressions.py
+++ b/django/db/models/expressions.py
@@ -978,7 +978,34 @@ class ExpressionWrapper(SQLiteNumericMixin, Expression):
         # `expression` must be included in the GROUP BY clause.
         return super().get_group_by_cols()
 
+    @cached_property
+    def empty_result_set_value(self):
+        """
+        Return the appropriate value when the wrapped expression results in an empty set.
+        For boolean expressions, this depends on whether the expression is negated.
+        """
+        # If the wrapped expression is a Q object, check if it's negated
+        if hasattr(self.expression, 'negated') and bool(self.expression.negated):
+            # For negated Q objects that would raise EmptyResultSet (like ~Q(pk__in=[])),
+            # the result should be True for boolean fields (since NOT (empty set) = all rows = True)
+            if isinstance(self.output_field, fields.BooleanField):
+                return True
+            # For other field types, use 1 as a reasonable default for "true" values
+            return 1
+        return NotImplemented
+
     def as_sql(self, compiler, connection):
+        # If the expression is a Q object, it needs to be resolved first
+        if hasattr(self.expression, 'resolve_expression'):
+            resolved_expression = self.expression.resolve_expression(compiler.query)
+            sql, params = compiler.compile(resolved_expression)
+            # Handle the case where a negated Q with empty IN returns empty SQL
+            if not sql and hasattr(self.expression, 'negated') and bool(self.expression.negated):
+                # This is likely a negated Q with empty IN, use the empty_result_set_value
+                empty_result_set_value = getattr(self, 'empty_result_set_value', NotImplemented)
+                if empty_result_set_value is not NotImplemented:
+                    return compiler.compile(Value(empty_result_set_value))
+            return sql, params
         return compiler.compile(self.expression)
 
     def __repr__(self):
diff --git a/reproduce_issue.py b/reproduce_issue.py
new file mode 100644
index 0000000000..655d7395b9
--- /dev/null
+++ b/reproduce_issue.py
@@ -0,0 +1,88 @@
+#!/usr/bin/env python3
+
+import os
+import sys
+import django
+from django.conf import settings
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DEBUG=True,
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+        ],
+        SECRET_KEY='test-secret-key',
+    )
+
+django.setup()
+
+from django.db import models
+from django.db.models import Q, ExpressionWrapper, BooleanField
+
+# Create a simple test model
+class TestModel(models.Model):
+    name = models.CharField(max_length=100)
+    
+    class Meta:
+        app_label = 'test'
+
+# Create the table
+from django.db import connection
+with connection.schema_editor() as schema_editor:
+    schema_editor.create_model(TestModel)
+
+def test_expression_wrapper_issue():
+    """Test the ExpressionWrapper issue with ~Q(pk__in=[])"""
+    
+    print("=== Testing ExpressionWrapper with Q(pk__in=[]) ===")
+    
+    # Test case 1: ExpressionWrapper(Q(pk__in=[])) - should work
+    try:
+        queryset1 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql1 = str(queryset1.query)
+        print(f"✓ Q(pk__in=[]) works: {sql1}")
+    except Exception as e:
+        print(f"✗ Q(pk__in=[]) failed: {e}")
+    
+    print("\n=== Testing ExpressionWrapper with ~Q(pk__in=[]) ===")
+    
+    # Test case 2: ExpressionWrapper(~Q(pk__in=[])) - should fail
+    try:
+        queryset2 = TestModel.objects.annotate(
+            foo=ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())
+        ).values("foo")
+        sql2 = str(queryset2.query)
+        print(f"✓ ~Q(pk__in=[]) works: {sql2}")
+    except Exception as e:
+        print(f"✗ ~Q(pk__in=[]) failed: {e}")
+    
+    print("\n=== Testing direct Q objects (for comparison) ===")
+    
+    # Test case 3: Direct Q(pk__in=[]) - should work
+    try:
+        queryset3 = TestModel.objects.filter(Q(pk__in=[]))
+        sql3 = str(queryset3.query)
+        print(f"✓ Direct Q(pk__in=[]) works: {sql3}")
+    except Exception as e:
+        print(f"✗ Direct Q(pk__in=[]) failed: {e}")
+    
+    # Test case 4: Direct ~Q(pk__in=[]) - should work
+    try:
+        queryset4 = TestModel.objects.filter(~Q(pk__in=[]))
+        sql4 = str(queryset4.query)
+        print(f"✓ Direct ~Q(pk__in=[]) works: {sql4}")
+    except Exception as e:
+        print(f"✗ Direct ~Q(pk__in=[]) failed: {e}")
+
+if __name__ == "__main__":
+    test_expression_wrapper_issue()
--------
2026-01-06 15:28:25,488 - INFO - Using instance container image: docker.io/swebench/sweb.eval.x86_64.matplotlib_1776_matplotlib-23562:latest. Please make sure this image exists. Submit an issue on https://github.com/OpenHands/OpenHands if you run into any issues.
2026-01-06 15:28:25,488 - INFO - Resource mapping for princeton-nlp__SWE-bench_Lite-test not found.
2026-01-06 15:28:25,489 - INFO - Logging LLM completions for instance matplotlib__matplotlib-23562 to ./continuum32/princeton-nlp__SWE-bench_Lite-test/CodeActAgent/GLM-4.6-FP8_maxiter_135/llm_completions/matplotlib__matplotlib-23562
2026-01-06 15:28:25,489 - INFO - Config file not found: config.toml. Error: [Errno 2] No such file or directory: 'config.toml'
2026-01-06 15:28:25,489 - INFO - Config file not found: [Errno 2] No such file or directory: 'config.toml'. Toml values have not been applied.
